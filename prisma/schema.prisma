generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// GasSettings - global configuration for gas stations
model GasSettings {
  id        String   @id @default(uuid())
  key       String   @unique // gasPrice, tankCapacity, tankCount, etc.
  value     String   // stored as string, parsed as needed
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@map("gas_settings")
}

model User {
  id               String         @id @default(uuid())
  name             String
  username         String         @unique
  password         String
  role             UserRole       @default(STAFF)
  stationId        String?
  createdAt        DateTime       @default(now())
  auditLogs        AuditLog[]
  sessions         Session[]
  shifts           Shift[]        @relation("ShiftStaff")
  shiftsClosedBy   Shift[]        @relation("ShiftClosedBy")
  shiftsLockedBy   Shift[]        @relation("ShiftLockedBy")
  transactions     Transaction[]
  meterReadings    MeterReading[] @relation("MeterCapturedBy")
  deviceTokens     DeviceToken[]
  priceBooks       PriceBook[]    @relation("PriceBookCreatedBy")
  reviewedAnomalies MeterAnomaly[]
  station          Station?       @relation(fields: [stationId], references: [id])

  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model Station {
  id                 String             @id @default(uuid())
  name               String
  type               StationType
  gasPrice           Decimal?
  gasStockAlert      Decimal?
  hasProducts        Boolean            @default(false)
  gasInitialStock    Decimal?           @default(0)
  dailyRecords       DailyRecord[]
  gasSupplies        GasSupply[]
  productInventories ProductInventory[]
  transactions       Transaction[]
  users              User[]
  deviceTokens       DeviceToken[]
  priceBooks         PriceBook[]
  dispensers         Dispenser[]

  @@map("stations")
}

// FuelProduct - ประเภทน้ำมัน (ดีเซล, แก๊สโซฮอล์ 91/95, E20, LPG)
model FuelProduct {
  id             String          @id @default(uuid())
  name           String // ดีเซล, แก๊สโซฮอล์ 91, etc.
  code           String          @unique // DIESEL, GASOHOL_91, etc.
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  nozzles        Nozzle[]
  priceBookLines PriceBookLine[]

  @@map("fuel_products")
}

// Dispenser - ตู้จ่ายน้ำมัน
model Dispenser {
  id        String    @id @default(uuid())
  stationId String
  code      String // D1, D2, ...
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  deletedAt DateTime?
  station   Station   @relation(fields: [stationId], references: [id])
  nozzles   Nozzle[]

  @@unique([stationId, code])
  @@map("dispensers")
}

// Nozzle - หัวจ่ายน้ำมัน
model Nozzle {
  id            String         @id @default(uuid())
  dispenserId   String
  code          String // N1, N2, ...
  productId     String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  deletedAt     DateTime?
  dispenser     Dispenser      @relation(fields: [dispenserId], references: [id])
  product       FuelProduct    @relation(fields: [productId], references: [id])
  meterReadings MeterReading[]

  @@unique([dispenserId, code])
  @@map("nozzles")
}

model Owner {
  id            String        @id @default(uuid())
  name          String
  phone         String?
  venderCode    String?
  groupType     OwnerGroup    @default(GENERAL_CREDIT)
  code          String?
  creditLimit   Decimal       @default(50000) // วงเงินเครดิต
  currentCredit Decimal       @default(0) // ยอดเครดิตคงค้าง
  createdAt     DateTime      @default(now())
  deletedAt     DateTime?
  invoices      Invoice[]
  transactions  Transaction[]
  trucks        Truck[]

  @@map("owners")
}

model Truck {
  id           String        @id @default(uuid())
  licensePlate String
  ownerId      String
  createdAt    DateTime      @default(now())
  deletedAt    DateTime?
  code         String?
  transactions Transaction[]
  owner        Owner         @relation(fields: [ownerId], references: [id])

  @@map("trucks")
}

model DailyRecord {
  id             String            @id @default(uuid())
  stationId      String
  date           DateTime
  retailPrice    Decimal           @default(31.34)
  wholesalePrice Decimal           @default(30.5)
  status         DailyRecordStatus @default(OPEN)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  gasPrice       Decimal?
  station        Station           @relation(fields: [stationId], references: [id])
  gaugeReadings  GaugeReading[]
  meters         MeterReading[]
  shifts         Shift[]
  transactions   Transaction[]

  @@unique([stationId, date])
  @@map("daily_records")
}

model Shift {
  id                   String               @id @default(uuid())
  dailyRecordId        String
  shiftNumber          Int
  staffId              String?
  status               ShiftStatus          @default(OPEN)
  createdAt            DateTime             @default(now())
  closedAt             DateTime?
  closedById           String?
  lockedAt             DateTime?
  lockedById           String?
  carryOverFromShiftId String?
  closingStock         Float?
  openingStock         Float?
  varianceNote         String? // Required if variance > threshold
  meters               MeterReading[]
  reconciliation       ShiftReconciliation?
  anomalies            MeterAnomaly[]
  dailyRecord          DailyRecord          @relation(fields: [dailyRecordId], references: [id])
  staff                User?                @relation("ShiftStaff", fields: [staffId], references: [id])
  closedBy             User?                @relation("ShiftClosedBy", fields: [closedById], references: [id])
  lockedBy             User?                @relation("ShiftLockedBy", fields: [lockedById], references: [id])

  @@unique([dailyRecordId, shiftNumber])
  @@map("shifts")
}

// Shift Reconciliation - snapshot ยอดสรุปเมื่อปิดกะ (แก้ไขไม่ได้)
model ShiftReconciliation {
  id                  String         @id @default(uuid())
  shiftId             String         @unique
  expectedFuelAmount  Decimal // ยอดที่ควรได้จากน้ำมัน
  expectedOtherAmount Decimal        @default(0) // ยอดจากสินค้าอื่น
  totalExpected       Decimal // รวมยอดที่ควรได้
  totalReceived       Decimal // รวมยอดที่รับจริง (cash+credit+transfer)
  cashReceived        Decimal        @default(0)
  creditReceived      Decimal        @default(0)
  transferReceived    Decimal        @default(0)
  variance            Decimal // expected - received
  varianceStatus      VarianceStatus @default(GREEN)
  createdAt           DateTime       @default(now())
  shift               Shift          @relation(fields: [shiftId], references: [id])

  @@map("shift_reconciliations")
}

// Meter Anomaly - บันทึกความผิดปกติของยอดขายมิเตอร์
model MeterAnomaly {
  id           String   @id @default(uuid())
  shiftId      String
  nozzleNumber Int
  soldQty      Decimal  // ยอดขายจริง
  averageQty   Decimal  // ค่าเฉลี่ย 7-30 วัน
  percentDiff  Decimal  // เปอร์เซ็นต์ต่างจากค่าเฉลี่ย
  severity     String   @default("WARNING") // WARNING, CRITICAL
  note         String?  // หมายเหตุจากพนักงาน
  reviewedById String?  // ผู้ตรวจสอบ
  reviewedAt   DateTime?
  createdAt    DateTime @default(now())
  shift        Shift    @relation(fields: [shiftId], references: [id])
  reviewedBy   User?    @relation(fields: [reviewedById], references: [id])

  @@map("meter_anomalies")
}

model MeterReading {
  id            String       @id @default(uuid())
  dailyRecordId String?
  nozzleNumber  Int // Keep for backward compatibility
  nozzleId      String? // New: link to Nozzle
  startReading  Decimal      @default(0)
  endReading    Decimal?
  soldQty       Decimal? // Auto-calculated: endReading - startReading
  startPhoto    String?
  endPhoto      String?
  shiftId       String?
  capturedById  String? // Who recorded this reading
  capturedAt    DateTime? // When was it recorded
  note          String? // Optional note
  dailyRecord   DailyRecord? @relation(fields: [dailyRecordId], references: [id])
  shift         Shift?       @relation(fields: [shiftId], references: [id])
  capturedBy    User?        @relation("MeterCapturedBy", fields: [capturedById], references: [id])
  nozzle        Nozzle?      @relation(fields: [nozzleId], references: [id])

  @@unique([dailyRecordId, nozzleNumber])
  @@unique([shiftId, nozzleNumber])
  @@map("meter_readings")
}

model Transaction {
  id               String       @id @default(uuid())
  stationId        String
  dailyRecordId    String?
  date             DateTime     @default(now())
  truckId          String?
  licensePlate     String?
  ownerId          String?
  ownerName        String?
  paymentType      PaymentType
  nozzleNumber     Int?
  liters           Decimal
  pricePerLiter    Decimal
  amount           Decimal
  productType      String?
  billBookNo       String?
  billNo           String?
  notes            String?
  recordedById     String
  invoiceId        String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  transferProofUrl String?
  deletedAt        DateTime?
  isVoided         Boolean      @default(false)
  voidReason       String?
  voidedAt         DateTime?
  voidedById       String?
  dailyRecord      DailyRecord? @relation(fields: [dailyRecordId], references: [id])
  invoice          Invoice?     @relation(fields: [invoiceId], references: [id])
  owner            Owner?       @relation(fields: [ownerId], references: [id])
  recordedBy       User         @relation(fields: [recordedById], references: [id])
  station          Station      @relation(fields: [stationId], references: [id])
  truck            Truck?       @relation(fields: [truckId], references: [id])

  @@map("transactions")
}

model Invoice {
  id            String        @id @default(uuid())
  ownerId       String
  dueDate       DateTime?
  totalAmount   Decimal
  status        InvoiceStatus @default(PENDING)
  paidAmount    Decimal       @default(0)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  invoiceNumber String        @unique
  owner         Owner         @relation(fields: [ownerId], references: [id])
  payments      Payment[]
  transactions  Transaction[]

  @@map("invoices")
}

model Payment {
  id            String   @id @default(uuid())
  invoiceId     String
  amount        Decimal
  paymentDate   DateTime @default(now())
  paymentMethod String
  notes         String?
  createdAt     DateTime @default(now())
  invoice       Invoice  @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

model GasSupply {
  id            String   @id @default(uuid())
  stationId     String
  date          DateTime
  liters        Decimal
  supplier      String?
  invoiceNo     String?
  pricePerLiter Decimal?
  totalCost     Decimal?
  notes         String?
  createdAt     DateTime @default(now())
  station       Station  @relation(fields: [stationId], references: [id])

  @@map("gas_supplies")
}

model GaugeReading {
  id            String       @id @default(uuid())
  stationId     String
  dailyRecordId String?
  date          DateTime
  percentage    Decimal
  photoUrl      String?
  recordedById  String?
  notes         String?
  createdAt     DateTime     @default(now())
  tankNumber    Int
  shiftNumber   Int          @default(0)
  dailyRecord   DailyRecord? @relation(fields: [dailyRecordId], references: [id])

  @@map("gauge_readings")
}

model Product {
  id        String             @id @default(uuid())
  name      String
  unit      String
  costPrice Decimal?
  salePrice Decimal
  createdAt DateTime           @default(now())
  inventory ProductInventory[]
  sales     ProductSale[]

  @@map("products")
}

model ProductInventory {
  id         String   @id @default(uuid())
  productId  String
  stationId  String
  quantity   Int      @default(0)
  alertLevel Int?
  updatedAt  DateTime @updatedAt
  product    Product  @relation(fields: [productId], references: [id])
  station    Station  @relation(fields: [stationId], references: [id])

  @@unique([productId, stationId])
  @@map("product_inventories")
}

model ProductReceipt {
  id        String   @id @default(uuid())
  productId String
  stationId String
  quantity  Int
  costPrice Decimal?
  supplier  String?
  invoiceNo String?
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@map("product_receipts")
}

model ProductSale {
  id          String      @id @default(uuid())
  productId   String
  stationId   String
  quantity    Int
  salePrice   Decimal
  paymentType PaymentType
  date        DateTime    @default(now())
  createdAt   DateTime    @default(now())
  product     Product     @relation(fields: [productId], references: [id])

  @@map("product_sales")
}

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  model     String
  recordId  String
  oldData   Json?
  newData   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

enum StationType {
  FULL
  SIMPLE
  GAS
}

enum PaymentType {
  CASH
  CREDIT
  TRANSFER
  BOX_TRUCK
  OIL_TRUCK_SUPACHAI
  CREDIT_CARD
}

enum OwnerGroup {
  SUGAR_FACTORY
  GENERAL_CREDIT
  BOX_TRUCK
  OIL_TRUCK
}

enum InvoiceStatus {
  PENDING
  PAID
  PARTIAL
}

enum DailyRecordStatus {
  OPEN
  CLOSED
}

enum UserRole {
  ADMIN
  STAFF
}

enum ShiftStatus {
  OPEN
  CLOSED
  LOCKED
}

enum VarianceStatus {
  GREEN // <= 200 บาท
  YELLOW // <= 500 บาท
  RED // > 500 บาท
}

// Device Token - ผูกอุปกรณ์กับสถานี
model DeviceToken {
  id         String   @id @default(uuid())
  deviceId   String   @unique // UUID จาก browser/app
  deviceName String? // ชื่อเครื่อง
  stationId  String?
  userId     String?
  lastUsedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  isActive   Boolean  @default(true)
  station    Station? @relation(fields: [stationId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])

  @@map("device_tokens")
}

// Price Book - ราคาน้ำมันตามวัน/นโยบาย
model PriceBook {
  id             String          @id @default(uuid())
  stationId      String? // null = ใช้กับทุกสถานี
  productType    String? // Legacy: DIESEL, GASOHOL_95, etc.
  retailPrice    Decimal? // Legacy: ราคาขายปลีก
  wholesalePrice Decimal? // Legacy: ราคาขายส่ง
  effectiveFrom  DateTime // เริ่มใช้ตั้งแต่
  effectiveTo    DateTime? // หมดอายุเมื่อ
  status         PriceBookStatus @default(DRAFT)
  createdAt      DateTime        @default(now())
  createdById    String?
  station        Station?        @relation(fields: [stationId], references: [id])
  createdBy      User?           @relation("PriceBookCreatedBy", fields: [createdById], references: [id])
  lines          PriceBookLine[]

  @@map("price_books")
}

// PriceBookLine - รายละเอียดราคาแต่ละผลิตภัณฑ์
model PriceBookLine {
  id           String      @id @default(uuid())
  priceBookId  String
  productId    String
  pricePerUnit Decimal // ราคาต่อลิตร
  priceBook    PriceBook   @relation(fields: [priceBookId], references: [id])
  product      FuelProduct @relation(fields: [productId], references: [id])

  @@unique([priceBookId, productId])
  @@map("price_book_lines")
}

enum PriceBookStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}
