generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model GasSettings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@map("gas_settings")
}

model User {
  id                      String         @id @default(uuid())
  name                    String
  username                String         @unique
  password                String
  role                    UserRole       @default(STAFF)
  stationId               String?
  createdAt               DateTime       @default(now())
  auditLogs               AuditLog[]
  deviceTokens            DeviceToken[]
  reviewedAnomalies       MeterAnomaly[]
  dailyAnomaliesReviewed  DailyAnomaly[] @relation("DailyAnomalyReviewer")
  meterReadings           MeterReading[] @relation("MeterCapturedBy")
  priceBooks              PriceBook[]    @relation("PriceBookCreatedBy")
  sessions                Session[]
  shiftsClosedBy          Shift[]        @relation("ShiftClosedBy")
  shiftsLockedBy          Shift[]        @relation("ShiftLockedBy")
  shifts                  Shift[]        @relation("ShiftStaff")
  transactions            Transaction[]
  station                 Station?       @relation(fields: [stationId], references: [id])

  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model Station {
  id                 String             @id @default(uuid())
  name               String
  type               StationType
  gasPrice           Decimal?
  gasStockAlert      Decimal?
  hasProducts        Boolean            @default(false)
  gasInitialStock    Decimal?           @default(0)
  dailyRecords       DailyRecord[]
  deviceTokens       DeviceToken[]
  dispensers         Dispenser[]
  gasSupplies        GasSupply[]
  priceBooks         PriceBook[]
  productInventories ProductInventory[]
  transactions       Transaction[]
  users              User[]
  dailyAnomalies     DailyAnomaly[]

  @@map("stations")
}

model FuelProduct {
  id             String          @id @default(uuid())
  name           String
  code           String          @unique
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  nozzles        Nozzle[]
  priceBookLines PriceBookLine[]

  @@map("fuel_products")
}

model Dispenser {
  id        String    @id @default(uuid())
  stationId String
  code      String
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  deletedAt DateTime?
  station   Station   @relation(fields: [stationId], references: [id])
  nozzles   Nozzle[]

  @@unique([stationId, code])
  @@map("dispensers")
}

model Nozzle {
  id            String         @id @default(uuid())
  dispenserId   String
  code          String
  productId     String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  deletedAt     DateTime?
  meterReadings MeterReading[]
  dispenser     Dispenser      @relation(fields: [dispenserId], references: [id])
  product       FuelProduct    @relation(fields: [productId], references: [id])

  @@unique([dispenserId, code])
  @@map("nozzles")
}

model Owner {
  id            String        @id @default(uuid())
  name          String
  phone         String?
  venderCode    String?
  groupType     OwnerGroup    @default(GENERAL_CREDIT)
  code          String?
  createdAt     DateTime      @default(now())
  deletedAt     DateTime?
  creditLimit   Decimal       @default(50000)
  currentCredit Decimal       @default(0)
  invoices      Invoice[]
  transactions  Transaction[]
  trucks        Truck[]

  @@map("owners")
}

model Truck {
  id           String        @id @default(uuid())
  licensePlate String
  ownerId      String
  createdAt    DateTime      @default(now())
  deletedAt    DateTime?
  code         String?
  transactions Transaction[]
  owner        Owner         @relation(fields: [ownerId], references: [id])

  @@map("trucks")
}

model DailyRecord {
  id             String            @id @default(uuid())
  stationId      String
  date           DateTime
  retailPrice    Decimal           @default(31.34)
  wholesalePrice Decimal           @default(30.5)
  status         DailyRecordStatus @default(OPEN)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  gasPrice       Decimal?
  station        Station           @relation(fields: [stationId], references: [id])
  gaugeReadings  GaugeReading[]
  meters         MeterReading[]
  shifts         Shift[]
  transactions   Transaction[]

  @@unique([stationId, date])
  @@map("daily_records")
}

model Shift {
  id                   String               @id @default(uuid())
  dailyRecordId        String
  shiftNumber          Int
  staffId              String?
  createdAt            DateTime             @default(now())
  closedAt             DateTime?
  carryOverFromShiftId String?
  closingStock         Float?
  openingStock         Float?
  closedById           String?
  lockedAt             DateTime?
  lockedById           String?
  varianceNote         String?
  status               ShiftStatus          @default(OPEN)
  anomalies            MeterAnomaly[]
  meters               MeterReading[]
  reconciliation       ShiftReconciliation?
  closedBy             User?                @relation("ShiftClosedBy", fields: [closedById], references: [id])
  dailyRecord          DailyRecord          @relation(fields: [dailyRecordId], references: [id])
  lockedBy             User?                @relation("ShiftLockedBy", fields: [lockedById], references: [id])
  staff                User?                @relation("ShiftStaff", fields: [staffId], references: [id])

  @@unique([dailyRecordId, shiftNumber])
  @@map("shifts")
}

model ShiftReconciliation {
  id                  String         @id @default(uuid())
  shiftId             String         @unique
  expectedFuelAmount  Decimal
  expectedOtherAmount Decimal        @default(0)
  totalExpected       Decimal
  totalReceived       Decimal
  cashReceived        Decimal        @default(0)
  creditReceived      Decimal        @default(0)
  transferReceived    Decimal        @default(0)
  variance            Decimal
  varianceStatus      VarianceStatus @default(GREEN)
  createdAt           DateTime       @default(now())
  shift               Shift          @relation(fields: [shiftId], references: [id])

  @@map("shift_reconciliations")
}

model MeterAnomaly {
  id           String    @id @default(uuid())
  shiftId      String
  nozzleNumber Int
  soldQty      Decimal
  averageQty   Decimal
  percentDiff  Decimal
  severity     String    @default("WARNING")
  note         String?
  reviewedById String?
  reviewedAt   DateTime?
  createdAt    DateTime  @default(now())
  reviewedBy   User?     @relation(fields: [reviewedById], references: [id])
  shift        Shift     @relation(fields: [shiftId], references: [id])

  @@map("meter_anomalies")
}

model DailyAnomaly {
  id            String    @id @default(uuid())
  stationId     String
  date          DateTime  @db.Date
  meterTotal    Decimal   // ยอดรวมมิเตอร์ (ลิตร)
  transTotal    Decimal   // ยอดรวม transactions (ลิตร)
  difference    Decimal   // ผลต่าง = transTotal - meterTotal
  severity      String    @default("WARNING") // WARNING / CRITICAL
  note          String?
  reviewedById  String?
  reviewedAt    DateTime?
  createdAt     DateTime  @default(now())
  
  station       Station   @relation(fields: [stationId], references: [id])
  reviewedBy    User?     @relation("DailyAnomalyReviewer", fields: [reviewedById], references: [id])

  @@unique([stationId, date])
  @@map("daily_anomalies")
}

model MeterReading {
  id            String       @id @default(uuid())
  dailyRecordId String?
  nozzleNumber  Int
  startReading  Decimal      @default(0)
  endReading    Decimal?
  startPhoto    String?
  endPhoto      String?
  shiftId       String?
  capturedAt    DateTime?
  capturedById  String?
  note          String?
  soldQty       Decimal?
  nozzleId      String?
  capturedBy    User?        @relation("MeterCapturedBy", fields: [capturedById], references: [id])
  dailyRecord   DailyRecord? @relation(fields: [dailyRecordId], references: [id])
  nozzle        Nozzle?      @relation(fields: [nozzleId], references: [id])
  shift         Shift?       @relation(fields: [shiftId], references: [id])

  @@unique([dailyRecordId, nozzleNumber])
  @@unique([shiftId, nozzleNumber])
  @@map("meter_readings")
}

model Transaction {
  id               String       @id @default(uuid())
  stationId        String
  dailyRecordId    String?
  date             DateTime     @default(now())
  truckId          String?
  licensePlate     String?
  ownerId          String?
  ownerName        String?
  paymentType      PaymentType
  nozzleNumber     Int?
  liters           Decimal
  pricePerLiter    Decimal
  amount           Decimal
  productType      String?
  billBookNo       String?
  billNo           String?
  notes            String?
  recordedById     String
  invoiceId        String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  transferProofUrl String?
  deletedAt        DateTime?
  isVoided         Boolean      @default(false)
  voidReason       String?
  voidedAt         DateTime?
  voidedById       String?
  dailyRecord      DailyRecord? @relation(fields: [dailyRecordId], references: [id])
  invoice          Invoice?     @relation(fields: [invoiceId], references: [id])
  owner            Owner?       @relation(fields: [ownerId], references: [id])
  recordedBy       User         @relation(fields: [recordedById], references: [id])
  station          Station      @relation(fields: [stationId], references: [id])
  truck            Truck?       @relation(fields: [truckId], references: [id])

  @@map("transactions")
}

model Invoice {
  id            String        @id @default(uuid())
  ownerId       String
  dueDate       DateTime?
  totalAmount   Decimal
  status        InvoiceStatus @default(PENDING)
  paidAmount    Decimal       @default(0)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  invoiceNumber String        @unique
  owner         Owner         @relation(fields: [ownerId], references: [id])
  payments      Payment[]
  transactions  Transaction[]

  @@map("invoices")
}

model Payment {
  id            String   @id @default(uuid())
  invoiceId     String
  amount        Decimal
  paymentDate   DateTime @default(now())
  paymentMethod String
  notes         String?
  createdAt     DateTime @default(now())
  invoice       Invoice  @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

model GasSupply {
  id            String   @id @default(uuid())
  stationId     String
  date          DateTime
  liters        Decimal
  supplier      String?
  invoiceNo     String?
  pricePerLiter Decimal?
  totalCost     Decimal?
  notes         String?
  createdAt     DateTime @default(now())
  station       Station  @relation(fields: [stationId], references: [id])

  @@map("gas_supplies")
}

model GaugeReading {
  id            String       @id @default(uuid())
  stationId     String
  dailyRecordId String?
  date          DateTime
  percentage    Decimal
  photoUrl      String?
  recordedById  String?
  notes         String?
  createdAt     DateTime     @default(now())
  tankNumber    Int
  shiftNumber   Int          @default(0)
  dailyRecord   DailyRecord? @relation(fields: [dailyRecordId], references: [id])

  @@map("gauge_readings")
}

model Product {
  id        String             @id @default(uuid())
  name      String
  unit      String
  costPrice Decimal?
  salePrice Decimal
  createdAt DateTime           @default(now())
  inventory ProductInventory[]
  sales     ProductSale[]

  @@map("products")
}

model ProductInventory {
  id         String   @id @default(uuid())
  productId  String
  stationId  String
  quantity   Int      @default(0)
  alertLevel Int?
  updatedAt  DateTime @updatedAt
  product    Product  @relation(fields: [productId], references: [id])
  station    Station  @relation(fields: [stationId], references: [id])

  @@unique([productId, stationId])
  @@map("product_inventories")
}

model ProductReceipt {
  id        String   @id @default(uuid())
  productId String
  stationId String
  quantity  Int
  costPrice Decimal?
  supplier  String?
  invoiceNo String?
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@map("product_receipts")
}

model ProductSale {
  id          String      @id @default(uuid())
  productId   String
  stationId   String
  quantity    Int
  salePrice   Decimal
  paymentType PaymentType
  date        DateTime    @default(now())
  createdAt   DateTime    @default(now())
  product     Product     @relation(fields: [productId], references: [id])

  @@map("product_sales")
}

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  model     String
  recordId  String
  oldData   Json?
  newData   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model DeviceToken {
  id         String   @id @default(uuid())
  deviceId   String   @unique
  deviceName String?
  stationId  String?
  userId     String?
  lastUsedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  isActive   Boolean  @default(true)
  station    Station? @relation(fields: [stationId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])

  @@map("device_tokens")
}

model PriceBook {
  id             String          @id @default(uuid())
  stationId      String?
  productType    String?
  retailPrice    Decimal?
  wholesalePrice Decimal?
  effectiveFrom  DateTime
  effectiveTo    DateTime?
  createdAt      DateTime        @default(now())
  createdById    String?
  status         PriceBookStatus @default(DRAFT)
  lines          PriceBookLine[]
  createdBy      User?           @relation("PriceBookCreatedBy", fields: [createdById], references: [id])
  station        Station?        @relation(fields: [stationId], references: [id])

  @@map("price_books")
}

model PriceBookLine {
  id           String      @id @default(uuid())
  priceBookId  String
  productId    String
  pricePerUnit Decimal
  priceBook    PriceBook   @relation(fields: [priceBookId], references: [id])
  product      FuelProduct @relation(fields: [productId], references: [id])

  @@unique([priceBookId, productId])
  @@map("price_book_lines")
}

enum StationType {
  FULL
  SIMPLE
  GAS
}

enum PaymentType {
  CASH
  CREDIT
  TRANSFER
  BOX_TRUCK
  OIL_TRUCK_SUPACHAI
  CREDIT_CARD
}

enum OwnerGroup {
  SUGAR_FACTORY
  GENERAL_CREDIT
  BOX_TRUCK
  OIL_TRUCK
}

enum InvoiceStatus {
  PENDING
  PAID
  PARTIAL
}

enum DailyRecordStatus {
  OPEN
  CLOSED
}

enum UserRole {
  ADMIN
  STAFF
}

enum ShiftStatus {
  OPEN
  CLOSED
  LOCKED
}

enum VarianceStatus {
  GREEN
  YELLOW
  RED
}

enum PriceBookStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}
